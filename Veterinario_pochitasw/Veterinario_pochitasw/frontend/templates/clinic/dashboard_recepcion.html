{% extends 'clinic/base.html' %}
{% load static %}

{% block content %}
<style>
    /* Simple CSS Grid Calendar */
    .calendar-container {
        display: none;
        /* Hidden by default, toggled via JS */
    }

    .calendar-header {
        display: grid;
        grid-template-columns: 60px repeat(6, 1fr);
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        text-align: center;
        padding: 10px 0;
    }

    .calendar-body {
        display: grid;
        grid-template-columns: 60px repeat(6, 1fr);
        grid-template-rows: repeat(11, 60px);
        /* 9:00 to 20:00 = 11 hours */
        overflow-y: auto;
        max-height: 600px;
        position: relative;
    }

    .time-slot {
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        text-align: center;
        font-size: 0.8rem;
        color: #6c757d;
        padding-top: 5px;
    }

    .day-column {
        border-right: 1px solid #e9ecef;
        position: relative;
    }

    .calendar-event {
        position: absolute;
        left: 2px;
        right: 2px;
        padding: 4px;
        font-size: 0.75rem;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        overflow: hidden;
        z-index: 10;
        transition: transform 0.2s;
    }

    .calendar-event:hover {
        transform: scale(1.02);
        z-index: 20;
    }

    /* Month Calendar Grid */
    .calendar-month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
    }

    .calendar-day-header {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .calendar-day-cell {
        background-color: white;
        min-height: 100px;
        padding: 8px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .calendar-day-cell:hover {
        background-color: #f8f9fa;
    }

    .calendar-day-cell.other-month {
        background-color: #f8f9fa;
        opacity: 0.5;
    }

    .calendar-day-cell.today {
        background-color: #e7f3ff;
        border: 2px solid #0d6efd;
    }

    .calendar-day-cell.weekend {
        background-color: #fff8f0;
    }

    .calendar-day-cell.holiday {
        background-color: #ffe6e6;
    }

    .day-number {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #212529;
    }

    .holiday-name {
        font-size: 10px;
        color: #dc3545;
        font-weight: 600;
        display: block;
        margin-top: 2px;
    }

    .appointment-block {
        font-size: 11px;
        padding: 2px 4px;
        margin: 2px 0;
        border-radius: 3px;
        background-color: #0d6efd;
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .more-appointments {
        font-size: 10px;
        color: #6c757d;
        font-weight: 600;
        margin-top: 4px;
    }
</style>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">Panel de Recepción</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registroRapidoModal">
                <i class="fa-solid fa-user-plus me-2"></i>Nuevo Cliente
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevaCitaModal">
                <i class="fa-solid fa-plus me-2"></i>Nueva Cita
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="recepTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda"
                type="button">Agenda</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="espera-tab" data-bs-toggle="tab" data-bs-target="#espera" type="button">Lista
                de Espera</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes"
                type="button">Clientes</button>
        </li>
    </ul>

    <div class="tab-content" id="recepTabContent">
        <!-- Agenda -->
        <div class="tab-pane fade show active" id="agenda" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="btn-view-list"
                                onclick="switchView('list')"><i class="fa-solid fa-list me-2"></i>Lista</button>
                            <button type="button" class="btn btn-outline-primary" id="btn-view-week"
                                onclick="switchView('week')"><i
                                    class="fa-solid fa-calendar-week me-2"></i>Semana</button>
                            <button type="button" class="btn btn-outline-primary" id="btn-view-month"
                                onclick="switchView('month')"><i class="fa-solid fa-calendar-days me-2"></i>Mes</button>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div id="calendar-view" class="calendar-container mb-4">
                        <div class="calendar-header">
                            <div>Hora</div>
                            <div>Lun</div>
                            <div>Mar</div>
                            <div>Mié</div>
                            <div>Jue</div>
                            <div>Vie</div>
                            <div>Sáb</div>
                        </div>
                        <div class="calendar-body" id="calendar-grid">
                            <!-- Time Slots generated by JS or loop -->
                            {% for i in "0123456789"|make_list %} <!-- Hacky loop 0-10 -->
                            <!-- We will populate this via JS for better control -->
                            {% endfor %}
                        </div>
                    </div>

                    <!-- List View (Table) -->
                    <div id="list-view" class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Paciente</th>
                                    <th>Dueño</th>
                                    <th>Veterinario</th>
                                    <th>Motivo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cita in citas %}
                                <tr>
                                    <td>{{ cita.fecha_hora|date:"d/m/Y H:i" }}</td>
                                    <td><span class="fw-bold">{{ cita.mascota.nombre }}</span> <small
                                            class="text-muted">({{ cita.mascota.especie }})</small></td>
                                    <td>{{ cita.mascota.cliente.nombre }} {{ cita.mascota.cliente.apellido }}</td>
                                    <td>{{ cita.veterinario.nombre }}</td>
                                    <td>{{ cita.motivo }}</td>
                                    <td>
                                        {% if cita.estado == 'CONFIRMADA' %}
                                        <span class="badge bg-success">Confirmada</span>
                                        {% elif cita.estado == 'AGENDADA' %}
                                        <span class="badge bg-primary">Agendada</span>
                                        {% elif cita.estado == 'REALIZADA' %}
                                        <span class="badge bg-secondary">Realizada</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">{{ cita.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <!-- Botón Reagendar/Editar -->
                                        {% if cita.estado != 'CANCELADA' and cita.estado != 'REALIZADA' %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="openRescheduleModal({
                                                id: {{ cita.id }},
                                                start: '{{ cita.fecha_hora|date:'Y-m-d\TH:i' }}',
                                                veterinario_id: {{ cita.veterinario.id|default:'null' }},
                                                mascota: '{{ cita.mascota.nombre }}'
                                            })" title="Reagendar cita">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-secondary" disabled
                                            title="No se puede editar">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        {% endif %}

                                        <!-- Botón Cancelar -->
                                        {% if cita.estado != 'CANCELADA' and cita.estado != 'REALIZADA' %}
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="confirmDeleteCita({{ cita.id }})" title="Cancelar cita">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">No hay citas registradas.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Month View -->
                    <div id="month-view" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-outline-secondary" onclick="navigateMonth(-1)">
                                <i class="fa-solid fa-chevron-left"></i> Anterior
                            </button>
                            <h4 id="current-month-title">Diciembre 2025</h4>
                            <button class="btn btn-outline-secondary" onclick="navigateMonth(1)">
                                Siguiente <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-month-grid">
                            <div class="calendar-day-header">Dom</div>
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mié</div>
                            <div class="calendar-day-header">Jue</div>
                            <div class="calendar-day-header">Vie</div>
                            <div class="calendar-day-header">Sáb</div>
                            <!-- Day cells will be added by JavaScript -->
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Lista Espera (Walk-in Queue) -->
        <div class="tab-pane fade" id="espera" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Cola de Atención Walk-in</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrarWalkinModal">
                            <i class="fa-solid fa-user-plus me-2"></i>Registrar Walk-in
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-walkin">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Cliente</th>
                                    <th>Mascota</th>
                                    <th>Motivo</th>
                                    <th>Prioridad</th>
                                    <th>Tiempo Espera</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="walkin-tbody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="fa-solid fa-spinner fa-spin me-2"></i>Cargando cola...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes -->
        <div class="tab-pane fade" id="clientes" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <input type="text" id="buscador-clientes" class="form-control mb-3"
                        placeholder="Buscar cliente por RUT o Nombre..." onkeyup="filtrarClientes()">
                    <table class="table" id="tabla-clientes">
                        <thead>
                            <tr>
                                <th>RUT</th>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Mascotas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes %}
                            <tr>
                                <td>{{ cliente.rut }}</td>
                                <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                                <td>{{ cliente.telefono }}</td>
                                <td>
                                    {% for m in cliente.mascotas.all %}
                                    <span class="badge bg-info text-dark">{{ m.nombre }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Cita -->
<div class="modal fade" id="nuevaCitaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agendar Nueva Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'crear_cita_recepcion' %}" id="nuevaCitaForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mascota</label>
                        <select class="form-select" name="mascota" required>
                            <option value="">Seleccionar Mascota (y Dueño)...</option>
                            {% for m in mascotas %}
                            <option value="{{ m.id }}">{{ m.nombre }} - {{ m.especie }} (Dueño: {{ m.cliente.nombre }}
                                {{ m.cliente.apellido }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Veterinario</label>
                        <select class="form-select" name="veterinario">
                            <option value="">Cualquiera</option>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">{{ vet.nombre }} - {{ vet.especialidad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha y Hora</label>
                        <input type="datetime-local" class="form-control" name="fecha_hora" min="2025-01-01T00:00"
                            max="2026-12-31T23:59" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="tipo">
                            <option value="CONSULTA">Consulta General</option>
                            <option value="CONTROL">Control / Revisión</option>
                            <option value="VACUNA">Vacunación</option>
                            <option value="CIRUGIA">Cirugía</option>
                            <option value="URGENCIA">Urgencia</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-control" name="motivo" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Agendar Cita</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal Registro Rápido -->
<div class="modal fade" id="registroRapidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Registrar Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'registro_rapido' %}" id="registroRapidoForm">
                    {% csrf_token %}
                    <h6 class="mb-3 text-muted border-bottom pb-2">Datos del Cliente</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">RUT * <i class="fa-solid fa-circle-info text-info ms-1"
                                    data-bs-toggle="tooltip"
                                    title="Formato: 12.345.678-9 (Puntos y guión automáticos)"></i></label>
                            <input type="text" class="form-control" name="username" required placeholder="12.345.678-9"
                                id="rutInput" maxlength="12">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                    </div>

                    <!-- Campos específicos de Cliente -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Teléfono *</label>
                            <div class="input-group">
                                <span class="input-group-text">+56</span>
                                <input type="number" class="form-control" name="telefono" required
                                    placeholder="912345678" onkeydown="return event.keyCode !== 69">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" name="direccion">
                            <!-- Hidden RUT input mirroring username for simplicity, or we let view handle it if form uses 'rut' field -->
                            <input type="hidden" name="rut" id="rutHidden">
                        </div>
                    </div>

                    <!-- Password default or generated (We'll use a default for simplicity or ask) -->
                    <div class="alert alert-info py-2">
                        <small><i class="fa-solid fa-info-circle me-1"></i> Se asignará contraseña temporal:
                            <strong>client123</strong></small>
                        <input type="hidden" name="password" value="client123">
                        <input type="hidden" name="confirm_password" value="client123">
                    </div>

                    <h6 class="mb-3 mt-4 text-muted border-bottom pb-2">Mascota Inicial (Opcional)</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre Mascota</label>
                            <input type="text" class="form-control" name="nombre">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Especie</label>
                            <select class="form-select" name="especie">
                                <option value="Perro">Perro</option>
                                <option value="Gato">Gato</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Género</label>
                            <select class="form-select" name="genero">
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Raza</label>
                            <input type="text" class="form-control" name="raza" value="Mestizo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Nacimiento (Aprox)</label>
                            <input type="date" class="form-control" name="fecha_nacimiento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Ingreso Clínica</label>
                            <input type="date" class="form-control" name="fecha_registro">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="registroRapidoForm" class="btn btn-success"
                    id="btnRegistrarCliente">Registrar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reagendar Cita -->
<div class="modal fade" id="reagendarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title">Reagendar Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="reagendarForm" action="">
                    {% csrf_token %}
                    <input type="hidden" id="reagendarCitaId" name="cita_id">
                    <p>Reagendando cita de: <strong id="reagendarMascota"></strong></p>

                    <div class="mb-3">
                        <label class="form-label">Nueva Fecha y Hora</label>
                        <input type="datetime-local" class="form-control" name="fecha_hora" id="reagendarFecha" required
                            onchange="checkUrgencia(this)">
                        <div class="form-check mt-2 d-none" id="alertUrgenciaReagendar">
                            <input class="form-check-input" type="checkbox" name="es_urgencia"
                                id="checkUrgenciaReagendar">
                            <label class="form-check-label text-danger fw-bold" for="checkUrgenciaReagendar">
                                <i class="fa-solid fa-triangle-exclamation"></i> Fecha especial (Domingo/Feriado).
                                Marcar como Urgencia para continuar.
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Veterinario</label>
                        <select class="form-select" name="veterinario" id="reagendarVeterinario">
                            <option value="">Cualquiera</option>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">{{ vet.nombre }} - {{ vet.especialidad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="reagendarForm" class="btn btn-primary">Confirmar Cambio</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmación Cancelar -->
<div class="modal fade" id="confirmarCierreModal" tabindex="-1" z-index="1060">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title">¿Descartar cambios?</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Tienes datos sin guardar. ¿Estás seguro de cerrar y perder la información?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Seguir editando</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarDescarte">Sí, descartar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const registroForm = document.getElementById('registroRapidoForm');

        if (registroForm) {
            // --- Lógica de input RUT (Auto-formato) ---
            const rutInput = document.getElementById('rutInput');
            if (rutInput) {
                const formatRut = (rut) => {
                    let value = rut.replace(/[^0-9kK]/g, '');
                    if (value.length <= 1) return value;
                    const dv = value.slice(-1);
                    let cuerpo = value.slice(0, -1);
                    cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    return `${cuerpo}-${dv}`;
                };
                rutInput.addEventListener('input', function () {
                    const oldVal = this.value;
                    this.value = formatRut(this.value);
                });
            }

            // --- Lógica de input Teléfono (Max 9 dígitos, prevenir 'e', '.', ',') ---
            const telInput = registroForm.querySelector('input[name="telefono"]');
            if (telInput) {
                // Bloquear caracteres no numéricos al presionar tecla
                telInput.addEventListener('keydown', function (e) {
                    const invalidChars = ['e', 'E', '.', ',', '-', '+'];
                    if (invalidChars.includes(e.key)) {
                        e.preventDefault();
                    }
                });

                telInput.addEventListener('input', function () {
                    if (this.value.length > 9) {
                        this.value = this.value.slice(0, 9);
                    }
                });
            }

            // --- Lógica Dirty Form y Cierre ---
            let isDirty = false;
            let intentionToClose = false; // Flag para evitar bucle infinito

            registroForm.addEventListener('change', () => isDirty = true);
            registroForm.addEventListener('input', () => isDirty = true);

            const modalRegistro = document.getElementById('registroRapidoModal');
            const bsModalRegistro = new bootstrap.Modal(modalRegistro);

            const modalConfirm = new bootstrap.Modal(document.getElementById('confirmarCierreModal'));
            const btnConfirmar = document.getElementById('btnConfirmarDescarte');

            // Interceptar evento hide
            modalRegistro.addEventListener('hide.bs.modal', function (e) {
                if (isDirty && !intentionToClose) {
                    e.preventDefault(); // Detener el cierre original
                    modalConfirm.show(); // Mostrar modal confirmación
                }
            });

            // Manejar confirmación de descarte
            btnConfirmar.addEventListener('click', function () {
                // El usuario confirmó descartar
                isDirty = false;
                intentionToClose = true;

                registroForm.reset();
                const alerts = document.getElementById('registroRapidoAlerts');
                if (alerts) alerts.innerHTML = '';

                modalConfirm.hide();
                // Esperar pequeño delay para que cierre el confirm y luego el principal
                setTimeout(() => {
                    const closeBtn = modalRegistro.querySelector('[data-bs-dismiss="modal"]');
                    if (closeBtn) closeBtn.click();
                    // O usar instancia bootstrap si el click no funciona bien por temas de foco
                    // bsModalRegistro.hide(); 
                }, 200);
            });

            // --- Lógica AJAX existente ---

            const modalBody = registroForm.parentElement;
            const modalAlertContainer = document.createElement('div');
            modalAlertContainer.id = 'registroRapidoAlerts';
            modalBody.insertBefore(modalAlertContainer, modalBody.firstChild);

            registroForm.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log("Interceptado submit de registroRapidoForm");

                // Logic que estaba en el onclick: copiar RUT a hidden
                const usernameInput = document.getElementsByName('username')[0];
                const rutHiddenInput = document.getElementById('rutHidden');
                if (usernameInput && rutHiddenInput) {
                    rutHiddenInput.value = usernameInput.value;
                }

                // Limpiar errores previos
                modalAlertContainer.innerHTML = '';

                const formData = new FormData(registroForm);

                const submitBtn = document.getElementById('btnRegistrarCliente');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Registrando...';
                }

                fetch(registroForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken') // Asegurar CSRF
                    }
                })
                    .then(response => {
                        return response.json().then(data => ({ status: response.status, body: data }));
                    })
                    .then(res => {
                        console.log("Respuesta servidor:", res);
                        if (res.body.success) {
                            // Éxito: Guardar mensaje flash y recargar
                            sessionStorage.setItem('flashMessage', 'Cliente registrado exitosamente');
                            sessionStorage.setItem('flashType', 'success');
                            location.reload();
                        } else {
                            // Error
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = 'Registrar Cliente';
                            }

                            let errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
                            errorHtml += '<strong>Error al registrar:</strong><ul class="mb-0">';

                            if (res.body.errors) {
                                if (typeof res.body.errors === 'string') {
                                    errorHtml += `<li>${res.body.errors}</li>`;
                                } else if (Array.isArray(res.body.errors)) {
                                    res.body.errors.forEach(err => errorHtml += `<li>${err}</li>`);
                                } else {
                                    for (const [field, msgs] of Object.entries(res.body.errors)) {
                                        // msgs puede ser array
                                        const msgText = Array.isArray(msgs) ? msgs.join(', ') : msgs;
                                        errorHtml += `<li><strong>${field}:</strong> ${msgText}</li>`;
                                    }
                                }
                            } else {
                                errorHtml += '<li>Ocurrió un error desconocido.</li>';
                            }

                            errorHtml += '</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            modalAlertContainer.innerHTML = errorHtml;

                            // Scroll al top del modal para ver errores
                            modalBody.scrollTop = 0;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetch:', error);
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Registrar Cliente';
                        }
                        modalAlertContainer.innerHTML = '<div class="alert alert-danger">Error de conexión o servidor. Intente más tarde.</div>';
                    });
            });
        }
        // --- Mostrar Mensaje Flash desde SessionStorage (al recargar) ---
        const flashMsg = sessionStorage.getItem('flashMessage');
        const flashType = sessionStorage.getItem('flashType');

        if (flashMsg) {
            let msgContainer = document.querySelector('.main-content .container');
            if (!msgContainer) {
                msgContainer = document.querySelector('body > .main-content');
                if (!msgContainer) msgContainer = document.body;
            }

            // Insertar alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${flashType || 'info'} alert-dismissible fade show mt-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
               <i class="fa-solid fa-check-circle me-2"></i> ${flashMsg}
               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            if (msgContainer.firstChild) {
                msgContainer.insertBefore(alertDiv, msgContainer.firstChild);
            } else {
                msgContainer.appendChild(alertDiv);
            }

            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 10000);

            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 10000);

            sessionStorage.removeItem('flashMessage');
            sessionStorage.removeItem('flashType');
        }

        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

    });
</script>
<!-- Modal Confirmar Cancelación Cita -->
<div class="modal fade" id="cancelarCitaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Cancelación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas cancelar esta cita? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <form id="formCancelarCita" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Sí, Cancelar Cita</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDeleteCita(citaId) {
        const form = document.getElementById('formCancelarCita');
        // Corregir URL hardcodeada con prefijo /api/
        form.action = `/api/dashboard/cancelar_cita/${citaId}/`;
        const modal = new bootstrap.Modal(document.getElementById('cancelarCitaModal'));
        modal.show();
    }

    // Validación de Urgencia y Fechas Pasadas
    document.addEventListener('DOMContentLoaded', function () {
        // Validación de Urgencia y Fechas Pasadas se manejan abajo o inline

        // Bloquear fechas pasadas en inputs datetime-local y date (registro mascota)
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const nowStr = now.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
            const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD

            // Datetime-local (Citas)
            const inputsFechaHora = document.querySelectorAll('input[type="datetime-local"]');
            inputsFechaHora.forEach(input => {
                input.min = nowStr;
            });

            // Date (Fecha registro mascota - dashboard)
            const inputFechaRegistro = document.querySelector('input[name="fecha_registro"]');
            if (inputFechaRegistro) {
                inputFechaRegistro.min = todayStr;
            }
        });
    });

    function checkUrgencia(input) {
        const fechaVal = new Date(input.value);
        if (isNaN(fechaVal.getTime())) return;

        // Contenedor de alerta (asumiendo estructura id="alertUrgencia...")
        // Para "Nueva Cita", el ID es alertUrgenciaNuevaCita
        // Para simplificar, buscamos el div .form-check hermano siguiente
        const alertDiv = input.parentElement.querySelector('.form-check');
        const checkInput = alertDiv ? alertDiv.querySelector('input[type="checkbox"]') : null;

        if (!alertDiv || !checkInput) return;

        let esEspecial = false;

        // 1. Domingo (0 en JS)
        if (fechaVal.getDay() === 0) {
            esEspecial = true;
        }

        // 2. Feriados Chile 2024-2025
        const fechaStr = fechaVal.toISOString().split('T')[0];
        const feriados = [
            '2024-01-01', '2024-03-29', '2024-03-30', '2024-05-01', '2024-05-21',
            '2024-06-09', '2024-06-20', '2024-07-16', '2024-08-15', '2024-09-18',
            '2024-09-19', '2024-09-20', '2024-10-12', '2024-10-27', '2024-10-31',
            '2024-11-01', '2024-12-08', '2024-12-25',
            '2025-01-01', '2025-04-18', '2025-04-19', '2025-05-01', '2025-05-21',
            '2025-06-20', '2025-06-29', '2025-07-16', '2025-08-15', '2025-09-18',
            '2025-09-19', '2025-10-12', '2025-10-31', '2025-11-01', '2025-12-08',
            '2025-12-25'
        ];

        if (feriados.includes(fechaStr)) {
            esEspecial = true;
        }

        if (esEspecial) {
            alertDiv.classList.remove('d-none');
            checkInput.required = true;
        } else {
            alertDiv.classList.add('d-none');
            checkInput.required = false;
            checkInput.checked = false;
        }
    }

    // Validación de Urgencia y Fechas Pasadas


    function checkUrgencia(input) {
        const fechaVal = new Date(input.value);
        if (isNaN(fechaVal.getTime())) return;

        // Contenedor de alerta (asumiendo estructura id="alertUrgencia...")
        // Para "Nueva Cita", el ID es alertUrgenciaNuevaCita
        // Para simplificar, buscamos el div .form-check hermano siguiente
        const alertDiv = input.parentElement.querySelector('.form-check');
        const checkInput = alertDiv ? alertDiv.querySelector('input[type="checkbox"]') : null;

        if (!alertDiv || !checkInput) return;

        let esEspecial = false;

        // 1. Domingo (0 en JS)
        if (fechaVal.getDay() === 0) {
            esEspecial = true;
        }

        // 2. Feriados Chile 2024-2025
        const fechaStr = fechaVal.toISOString().split('T')[0];
        const feriados = [
            '2024-01-01', '2024-03-29', '2024-03-30', '2024-05-01', '2024-05-21',
            '2024-06-09', '2024-06-20', '2024-07-16', '2024-08-15', '2024-09-18',
            '2024-09-19', '2024-09-20', '2024-10-12', '2024-10-27', '2024-10-31',
            '2024-11-01', '2024-12-08', '2024-12-25',
            '2025-01-01', '2025-04-18', '2025-04-19', '2025-05-01', '2025-05-21',
            '2025-06-20', '2025-06-29', '2025-07-16', '2025-08-15', '2025-09-18',
            '2025-09-19', '2025-10-12', '2025-10-31', '2025-11-01', '2025-12-08',
            '2025-12-25'
        ];

        if (feriados.includes(fechaStr)) {
            esEspecial = true;
        }

        if (esEspecial) {
            alertDiv.classList.remove('d-none');
            checkInput.required = true;
        } else {
            alertDiv.classList.add('d-none');
            checkInput.required = false;
            checkInput.checked = false;
        }
    }
</script>

<!-- Calendar JavaScript -->
<script src="{% static 'js/calendar.js' %}"></script>
<script>
    // Load appointment data
    {% if citas %}
    window.allAppointments = [
        {% for cita in citas %}
    {
        id: { { cita.id } },
        fecha_hora: '{{ cita.fecha_hora|date:"Y-m-d\TH:i" }}',
            mascota_nombre: '{{ cita.mascota.nombre|escapejs }}',
                tipo: '{{ cita.tipo|escapejs }}',
                    veterinario_nombre: '{{ cita.veterinario.nombre|escapejs }}',
                        estado: '{{ cita.estado|escapejs }}'
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
    ];
    {% else %}
    window.allAppointments = [];
    {% endif %}
</script>

<!-- Modal: Registrar Walk-in -->
<div class="modal fade" id="registrarWalkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Paciente Walk-in</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-walkin">
                    <div class="mb-3">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" id="walkin-cliente" required>
                            <option value="">Seleccione cliente...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mascota *</label>
                        <select class="form-select" id="walkin-mascota" required disabled>
                            <option value="">Primero seleccione un cliente</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Motivo de la visita *</label>
                        <textarea class="form-control" id="walkin-motivo" rows="3" required
                            placeholder="Ej: Vacuna antirrábica, Control general, Herida en pata..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Prioridad</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="prioridad" id="prioridad-normal"
                                    value="NORMAL" checked>
                                <label class="form-check-label" for="prioridad-normal">
                                    <i class="fa-solid fa-circle text-success"></i> Normal
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="prioridad" id="prioridad-urgente"
                                    value="URGENTE">
                                <label class="form-check-label" for="prioridad-urgente">
                                    <i class="fa-solid fa-circle text-danger"></i> Urgente
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="registrarWalkin()">
                    <i class="fa-solid fa-check me-2"></i>Registrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reagendar Cita Modal -->
<div class="modal fade" id="reagendarCitaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reagendar Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-reagendar" method="POST" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p><strong>Paciente:</strong> <span id="reagendar-mascota"></span></p>

                    <div class="mb-3">
                        <label for="reagendar-fecha" class="form-label">Nueva Fecha y Hora *</label>
                        <input type="datetime-local" class="form-control" id="reagendar-fecha" name="fecha_hora"
                            required>
                    </div>

                    <div class="mb-3">
                        <label for="reagendar-veterinario" class="form-label">Veterinario *</label>
                        <select class="form-select" id="reagendar-veterinario" name="veterinario" required>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">Dr. {{ vet.nombre }} {{ vet.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="reagendar-urgencia" name="es_urgencia">
                            <label class="form-check-label" for="reagendar-urgencia">Es Urgencia (Permite
                                Domingos/Feriados)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="reagendar-motivo" class="form-label">Motivo de Reagendamiento *</label>
                        <textarea class="form-control" id="reagendar-motivo" name="motivo_reagendamiento" rows="2"
                            required placeholder="Indique la razón del cambio..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Walk-in Queue JavaScript -->
<script>
    // CSRF Token global
    const csrftoken = '{{ csrf_token }}';

    // Abrir modal de reagendar (función global)
    window.openRescheduleModal = function (data) {
        // data: {id, start, veterinario_id, mascota}
        const modalEl = document.getElementById('reagendarCitaModal');
        if (!modalEl) {
            console.error('Modal de reagendar no encontrado');
            return;
        }

        document.getElementById('reagendar-mascota').textContent = data.mascota;
        document.getElementById('reagendar-fecha').value = data.start;
        document.getElementById('reagendar-veterinario').value = data.veterinario_id;
        document.getElementById('reagendar-motivo').value = ''; // Limpiar motivo anterior
        // Reset checkbox
        document.getElementById('reagendar-urgencia').checked = false;

        // Configurar action del form
        const form = document.getElementById('form-reagendar');
        form.action = `/api/dashboard/reagendar_cita/${data.id}/`;

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    };

    // Cargar mascotas cuando se selecciona un cliente
    document.getElementById('walkin-cliente')?.addEventListener('change', function () {
        const clienteId = this.value;
        const mascotaSelect = document.getElementById('walkin-mascota');

        if (!clienteId) {
            mascotaSelect.disabled = true;
            mascotaSelect.innerHTML = '<option value="">Primero seleccione un cliente</option>';
            return;
        }

        // Filtrar mascotas del cliente seleccionado
        console.log(`Cargando mascotas para cliente ID: ${clienteId}`);
        fetch(`/api/mascotas/?cliente=${clienteId}`)
            .then(r => {
                console.log('Response status:', r.status);
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('Data recibida:', data);
                // DRF devuelve {results: [...]} cuando hay paginación
                const mascotas = data.results || data;
                console.log('Mascotas:', mascotas);

                mascotaSelect.disabled = false;
                mascotaSelect.innerHTML = '<option value="">Seleccione mascota...</option>';

                if (mascotas.length === 0) {
                    mascotaSelect.innerHTML += '<option value="">Este cliente no tiene mascotas</option>';
                    return;
                }

                mascotas.forEach(m => {
                    mascotaSelect.innerHTML += `<option value="${m.id}">${m.nombre} (${m.especie})</option>`;
                });
            })
            .catch(err => {
                console.error('Error completo:', err);
                console.error('Error cargando mascotas:', err.message);
                mascotaSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
            });
    });

    // Registrar nuevo walk-in
    function registrarWalkin() {
        const form = document.getElementById('form-walkin');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const data = {
            cliente: document.getElementById('walkin-cliente').value,
            mascota: document.getElementById('walkin-mascota').value,
            motivo: document.getElementById('walkin-motivo').value,
            prioridad: document.querySelector('input[name="prioridad"]:checked').value,
            estado: 'ESPERANDO'
        };

        fetch('/api/lista-espera/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(result => {
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('registrarWalkinModal')).hide();
                // Limpiar formulario
                form.reset();
                document.getElementById('walkin-mascota').disabled = true;
                // Recargar cola
                cargarColaWalkin();
                // Paciente registrado exitosamente (sin alert molesto)
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al registrar paciente');
            });
    }

    // Cargar cola del día
    function cargarColaWalkin() {
        fetch('/api/lista-espera/hoy/')
            .then(r => r.json())
            .then(cola => {
                const tbody = document.getElementById('walkin-tbody');

                if (cola.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fa-solid fa-inbox me-2"></i>No hay pacientes en espera
                        </td>
                    </tr>`;
                    return;
                }

                tbody.innerHTML = cola.map(p => {
                    const prioridadBadge = p.prioridad === 'URGENTE'
                        ? '<span class="badge bg-danger">Urgente</span>'
                        : '<span class="badge bg-success">Normal</span>';

                    const estadoBadge = p.estado === 'ESPERANDO'
                        ? '<span class="badge bg-warning text-dark">En Espera</span>'
                        : '<span class="badge bg-info">En Atención</span>';

                    const tiempoEspera = p.tiempo_espera
                        ? `${p.tiempo_espera} min`
                        : '-';

                    const acciones = p.estado === 'ESPERANDO'
                        ? `<button class="btn btn-sm btn-primary me-1" onclick="llamarSiguiente(${p.id})">
                           <i class="fa-solid fa-bell"></i> Llamar
                       </button>
                       <button class="btn btn-sm btn-danger" onclick="cancelarTurno(${p.id})">
                           <i class="fa-solid fa-times"></i>
                       </button>`
                        : `<button class="btn btn-sm btn-success" onclick="marcarAtendido(${p.id})">
                           <i class="fa-solid fa-check"></i> Atendido
                       </button>`;

                    return `
                    <tr>
                        <td><strong>#${String(p.numero_turno).padStart(3, '0')}</strong></td>
                        <td>${p.cliente_nombre || 'N/A'}</td>
                        <td>${p.mascota_nombre || 'N/A'}</td>
                        <td>${p.motivo || '-'}</td>
                        <td>${prioridadBadge}</td>
                        <td>${tiempoEspera}</td>
                        <td>${estadoBadge}</td>
                        <td>${acciones}</td>
                    </tr>`;
                }).join('');
            })
            .catch(err => {
                console.error('Error cargando cola:', err);
                document.getElementById('walkin-tbody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>Error cargando cola
                    </td>
                </tr>`;
            });
    }

    // Llamar siguiente paciente
    function llamarSiguiente(id) {


        fetch(`/api/lista-espera/${id}/llamar_siguiente/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al llamar paciente');
            });
    }

    // Marcar como atendido
    function marcarAtendido(id) {


        fetch(`/api/lista-espera/${id}/marcar_atendido/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al marcar como atendido');
            });
    }

    // Cancelar turno
    function cancelarTurno(id) {
        if (!confirm('¿Cancelar este turno?')) return;

        fetch(`/api/lista-espera/${id}/cancelar_turno/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al cancelar turno');
            });
    }

    // Helper para CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Cargar cola al cambiar al tab
    document.getElementById('espera-tab')?.addEventListener('shown.bs.tab', function () {
        cargarColaWalkin();
    });

    // Auto-refresh cada 30 segundos si el tab está activo
    setInterval(function () {
        const esperaTab = document.getElementById('espera');
        if (esperaTab && esperaTab.classList.contains('active')) {
            cargarColaWalkin();
        }
    }, 30000);

    // Filtro de Clientes en tiempo real
    function filtrarClientes() {
        const input = document.getElementById("buscador-clientes");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("tabla-clientes");
        const tr = table.getElementsByTagName("tr");

        // Recorrer todas las filas de la tabla (empezando en 1 para saltar el header)
        for (let i = 1; i < tr.length; i++) {
            // Columna 0: RUT, Columna 1: Nombre
            const tdRut = tr[i].getElementsByTagName("td")[0];
            const tdNombre = tr[i].getElementsByTagName("td")[1];

            if (tdRut || tdNombre) {
                const txtRut = tdRut.textContent || tdRut.innerText;
                const txtNombre = tdNombre.textContent || tdNombre.innerText;

                if (txtRut.toUpperCase().indexOf(filter) > -1 || txtNombre.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>

{% endblock %}