{% extends 'clinic/base.html' %}
{% load static %}

{% block content %}
<style>
    /* Dashboard Layout */
    .dashboard-container {
        display: flex;
        gap: 1.5rem;
        min-height: calc(100vh - 200px);
    }

    .sidebar {
        width: 300px;
        flex-shrink: 0;
    }

    .main-content-area {
        flex: 1;
        min-width: 0;
    }

    /* Quick Actions Card */
    .quick-actions-card {
        background: linear-gradient(135deg, #87CEEB 0%, #A8DCED 100%);
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(135, 206, 235, 0.3);
        margin-bottom: 1.5rem;
    }

    .quick-actions-card h5 {
        font-weight: 700;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .quick-action-btn {
        width: 100%;
        margin-bottom: 0.75rem;
        background: white;
        color: #87CEEB;
        border: none;
        padding: 0.75rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: #f8f9fa;
    }

    .quick-action-btn i {
        margin-right: 0.5rem;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 10px rgba(135, 206, 235, 0.15);
        border-left: 4px solid #87CEEB;
    }

    .stat-card.success {
        border-left-color: #98FF98;
    }

    .stat-card.warning {
        border-left-color: #FFD700;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #87CEEB;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
        margin-top: 0.5rem;
    }

    /* Compact Table */
    .compact-table {
        font-size: 0.9rem;
    }

    .compact-table th {
        background-color: #F0F9FF;
        color: #4A4A4A;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
        border-bottom: 2px solid #87CEEB;
    }

    .compact-table td {
        padding: 0.75rem 0.5rem;
        vertical-align: middle;
    }

    .compact-table tbody tr:hover {
        background-color: #F8FCFF;
    }

    /* Badge Improvements */
    .badge-custom {
        padding: 0.35em 0.65em;
        font-weight: 600;
        border-radius: 6px;
    }

    .badge-agendada {
        background-color: #87CEEB;
        color: white;
    }

    .badge-confirmada {
        background-color: #98FF98;
        color: #2D5016;
    }

    .badge-realizada {
        background-color: #A9A9A9;
        color: white;
    }

    .badge-cancelada {
        background-color: #FFE4E1;
        color: #DC3545;
    }

    .badge-reagendada {
        background-color: #FFD700;
        /* Dorado Suave */
        color: #8B6914;
    }

    /* Action Buttons */
    .btn-action {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
        margin: 0 0.25rem;
    }

    /* Tab Styling */
    .nav-tabs .nav-link {
        color: #6B7280;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        color: #87CEEB;
        border-bottom-color: #87CEEB;
        background: none;
    }

    .nav-tabs .nav-link:hover {
        color: #87CEEB;
        border-bottom-color: #A8DCED;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .dashboard-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold" style="color: #87CEEB;">Panel de Recepción</h2>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Quick Actions -->
            <div class="quick-actions-card">
                <h5><i class="fa-solid fa-bolt me-2"></i>Acciones Rápidas</h5>
                <button class="quick-action-btn" data-bs-toggle="modal" data-bs-target="#registroRapidoModal">
                    <i class="fa-solid fa-user-plus"></i>Nuevo Cliente
                </button>
                <button class="quick-action-btn" data-bs-toggle="modal" data-bs-target="#nuevaCitaModal">
                    <i class="fa-solid fa-calendar-plus"></i>Nueva Cita
                </button>
                <button class="quick-action-btn" data-bs-toggle="modal" data-bs-target="#registrarWalkinModal">
                    <i class="fa-solid fa-person-walking"></i>Registrar Walk-in
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ citas|length }}</div>
                    <div class="stat-label">Citas Hoy</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" style="color: #98FF98;">{{ lista_espera|length }}</div>
                    <div class="stat-label">En Espera</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" style="color: #FFD700;">{{ clientes|length }}</div>
                    <div class="stat-label">Clientes Totales</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content-area">
            <ul class="nav nav-tabs mb-4" id="recepTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda"
                        type="button">
                        <i class="fa-solid fa-calendar-days me-2"></i>Agenda
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="espera-tab" data-bs-toggle="tab" data-bs-target="#espera"
                        type="button">
                        <i class="fa-solid fa-clock me-2"></i>Lista de Espera
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes"
                        type="button">
                        <i class="fa-solid fa-users me-2"></i>Clientes
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="recepTabContent">
                <!-- Agenda Tab -->
                <div class="tab-pane fade show active" id="agenda" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table compact-table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Paciente</th>
                                            <th>Dueño</th>
                                            <th>Veterinario</th>
                                            <th>Motivo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cita in citas %}
                                        <tr>
                                            <td>
                                                <div class="fw-bold">{{ cita.fecha_hora|date:"H:i" }}</div>
                                                <small class="text-muted">{{ cita.fecha_hora|date:"d/m" }}</small>
                                            </td>
                                            <td>
                                                <span class="fw-bold">{{ cita.mascota.nombre }}</span>
                                                <small class="text-muted d-block">{{ cita.mascota.especie }}</small>
                                            </td>
                                            <td>{{ cita.mascota.cliente.nombre }} {{ cita.mascota.cliente.apellido }}
                                            </td>
                                            <td>{{ cita.veterinario.nombre }}</td>
                                            <td>{{ cita.motivo|truncatewords:3 }}</td>
                                            <td>
                                                {% if cita.estado == 'CONFIRMADA' %}
                                                <span class="badge badge-custom badge-confirmada">Confirmada</span>
                                                {% elif cita.estado == 'AGENDADA' %}
                                                <span class="badge badge-custom badge-agendada">Agendada</span>
                                                {% elif cita.estado == 'REAGENDADA' %}
                                                <span class="badge badge-custom badge-reagendada">Reagendada</span>
                                                {% elif cita.estado == 'REALIZADA' %}
                                                <span class="badge badge-custom badge-realizada">Realizada</span>
                                                {% elif cita.estado == 'CANCELADA' %}
                                                <span class="badge badge-custom badge-cancelada">Cancelada</span>
                                                {% else %}
                                                <span class="badge badge-custom badge-cancelada">{{ cita.estado
                                                    }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if cita.estado != 'CANCELADA' and cita.estado != 'REALIZADA' %}
                                                <button class="btn btn-sm btn-outline-primary btn-action" onclick="openRescheduleModal({
                                                        id: {{ cita.id }},
                                                        start: '{{ cita.fecha_hora|date:'Y-m-d\TH:i' }}',
                                                        veterinario_id: {{ cita.veterinario.id|default:'null' }},
                                                        mascota: '{{ cita.mascota.nombre }}'
                                                    })" title="Reagendar">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger btn-action"
                                                    onclick="confirmDeleteCita({{ cita.id }})" title="Cancelar">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                                {% else %}
                                                <span class="text-muted small">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="fa-regular fa-calendar-xmark fa-2x mb-2 d-block"></i>
                                                No hay citas registradas
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista Espera Tab -->
                <div class="tab-pane fade" id="espera" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table compact-table table-hover" id="tabla-walkin">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Cliente</th>
                                            <th>Mascota</th>
                                            <th>Motivo</th>
                                            <th>Prioridad</th>
                                            <th>Tiempo Espera</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="walkin-tbody">
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <i class="fa-solid fa-spinner fa-spin me-2"></i>Cargando cola...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clientes Tab -->
                <div class="tab-pane fade" id="clientes" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <input type="text" id="buscador-clientes" class="form-control mb-3"
                                placeholder="Buscar cliente por RUT o Nombre..." onkeyup="filtrarClientes()">
                            <div class="table-responsive">
                                <table class="table compact-table" id="tabla-clientes">
                                    <thead>
                                        <tr>
                                            <th>RUT</th>
                                            <th>Nombre</th>
                                            <th>Teléfono</th>
                                            <th>Mascotas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cliente in clientes %}
                                        <tr>
                                            <td>{{ cliente.rut }}</td>
                                            <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                                            <td>{{ cliente.telefono }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary"
                                                    onclick="openPetsModal({{ cliente.id }}, '{{ cliente.nombre }} {{ cliente.apellido }}')"
                                                    title="Ver y editar mascotas"><i class="fa-solid fa-paw"></i> Ver
                                                    Mascotas</button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Cita -->
<div class="modal fade" id="nuevaCitaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agendar Nueva Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'crear_cita_recepcion' %}" id="nuevaCitaForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mascota</label>
                        <select class="form-select" name="mascota" required>
                            <option value="">Seleccionar Mascota (y Dueño)...</option>
                            {% for m in mascotas %}
                            <option value="{{ m.id }}">{{ m.nombre }} - {{ m.especie }} (Dueño: {{ m.cliente.nombre }}
                                {{ m.cliente.apellido }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Veterinario</label>
                        <select class="form-select" name="veterinario">
                            <option value="">Cualquiera</option>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">{{ vet.nombre }} - {{ vet.especialidad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha y Hora</label>
                        <input type="datetime-local" class="form-control" name="fecha_hora" min="2025-01-01T00:00"
                            max="2026-12-31T23:59" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="tipo">
                            <option value="CONSULTA">Consulta General</option>
                            <option value="CONTROL">Control / Revisión</option>
                            <option value="VACUNA">Vacunación</option>
                            <option value="CIRUGIA">Cirugía</option>
                            <option value="URGENCIA">Urgencia</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-control" name="motivo" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Agendar Cita</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal Registro Rápido -->
<div class="modal fade" id="registroRapidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Registrar Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'registro_rapido' %}" id="registroRapidoForm">
                    {% csrf_token %}
                    <h6 class="mb-3 text-muted border-bottom pb-2">Datos del Cliente</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">RUT * <i class="fa-solid fa-circle-info text-info ms-1"
                                    data-bs-toggle="tooltip"
                                    title="Formato: 12.345.678-9 (Puntos y guión automáticos)"></i></label>
                            <input type="text" class="form-control" name="username" required placeholder="12.345.678-9"
                                id="rutInput" maxlength="12">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                    </div>

                    <!-- Campos específicos de Cliente -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Teléfono *</label>
                            <div class="input-group">
                                <span class="input-group-text">+56</span>
                                <input type="number" class="form-control" name="telefono" required
                                    placeholder="912345678" onkeydown="return event.keyCode !== 69">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" name="direccion">
                            <!-- Hidden RUT input mirroring username for simplicity, or we let view handle it if form uses 'rut' field -->
                            <input type="hidden" name="rut" id="rutHidden">
                        </div>
                    </div>

                    <!-- Password default or generated (We'll use a default for simplicity or ask) -->
                    <div class="alert alert-info py-2">
                        <small><i class="fa-solid fa-info-circle me-1"></i> Se asignará contraseña temporal:
                            <strong>client123</strong></small>
                        <input type="hidden" name="password" value="client123">
                        <input type="hidden" name="confirm_password" value="client123">
                    </div>

                    <h6 class="mb-3 mt-4 text-muted border-bottom pb-2">Mascota Inicial (Opcional)</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre Mascota</label>
                            <input type="text" class="form-control" name="nombre">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Especie</label>
                            <select class="form-select" name="especie">
                                <option value="Perro">Perro</option>
                                <option value="Gato">Gato</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Género</label>
                            <select class="form-select" name="genero">
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Raza</label>
                            <input type="text" class="form-control" name="raza" value="Mestizo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Nacimiento (Aprox)</label>
                            <input type="date" class="form-control" name="fecha_nacimiento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Ingreso Clínica</label>
                            <input type="date" class="form-control" name="fecha_registro">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="registroRapidoForm" class="btn btn-success"
                    id="btnRegistrarCliente">Registrar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reagendar Cita -->
<div class="modal fade" id="reagendarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title">Reagendar Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="reagendarForm" action="">
                    {% csrf_token %}
                    <input type="hidden" id="reagendarCitaId" name="cita_id">
                    <p>Reagendando cita de: <strong id="reagendarMascota"></strong></p>

                    <div class="mb-3">
                        <label class="form-label">Nueva Fecha y Hora</label>
                        <input type="datetime-local" class="form-control" name="fecha_hora" id="reagendarFecha" required
                            onchange="checkUrgencia(this)">
                        <div class="form-check mt-2 d-none" id="alertUrgenciaReagendar">
                            <input class="form-check-input" type="checkbox" name="es_urgencia"
                                id="checkUrgenciaReagendar">
                            <label class="form-check-label text-danger fw-bold" for="checkUrgenciaReagendar">
                                <i class="fa-solid fa-triangle-exclamation"></i> Fecha especial (Domingo/Feriado).
                                Marcar como Urgencia para continuar.
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Veterinario</label>
                        <select class="form-select" name="veterinario" id="reagendarVeterinario">
                            <option value="">Cualquiera</option>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">{{ vet.nombre }} - {{ vet.especialidad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="reagendarForm" class="btn btn-primary">Confirmar Cambio</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmación Cancelar -->
<div class="modal fade" id="confirmarCierreModal" tabindex="-1" z-index="1060">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title">¿Descartar cambios?</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Tienes datos sin guardar. ¿Estás seguro de cerrar y perder la información?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Seguir editando</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarDescarte">Sí, descartar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const registroForm = document.getElementById('registroRapidoForm');

        if (registroForm) {
            // --- Lógica de input RUT (Auto-formato) ---
            const rutInput = document.getElementById('rutInput');
            if (rutInput) {
                const formatRut = (rut) => {
                    let value = rut.replace(/[^0-9kK]/g, '');
                    if (value.length <= 1) return value;
                    const dv = value.slice(-1);
                    let cuerpo = value.slice(0, -1);
                    cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    return `${cuerpo}-${dv}`;
                };
                rutInput.addEventListener('input', function () {
                    const oldVal = this.value;
                    this.value = formatRut(this.value);
                });
            }

            // --- Lógica de input Teléfono (Max 9 dígitos, prevenir 'e', '.', ',') ---
            const telInput = registroForm.querySelector('input[name="telefono"]');
            if (telInput) {
                // Bloquear caracteres no numéricos al presionar tecla
                telInput.addEventListener('keydown', function (e) {
                    const invalidChars = ['e', 'E', '.', ',', '-', '+'];
                    if (invalidChars.includes(e.key)) {
                        e.preventDefault();
                    }
                });

                telInput.addEventListener('input', function () {
                    if (this.value.length > 9) {
                        this.value = this.value.slice(0, 9);
                    }
                });
            }

            // --- Lógica Dirty Form y Cierre ---
            let isDirty = false;
            let intentionToClose = false; // Flag para evitar bucle infinito

            registroForm.addEventListener('change', () => isDirty = true);
            registroForm.addEventListener('input', () => isDirty = true);

            const modalRegistro = document.getElementById('registroRapidoModal');
            const bsModalRegistro = new bootstrap.Modal(modalRegistro);

            const modalConfirm = new bootstrap.Modal(document.getElementById('confirmarCierreModal'));
            const btnConfirmar = document.getElementById('btnConfirmarDescarte');

            // Interceptar evento hide
            modalRegistro.addEventListener('hide.bs.modal', function (e) {
                if (isDirty && !intentionToClose) {
                    e.preventDefault(); // Detener el cierre original
                    modalConfirm.show(); // Mostrar modal confirmación
                }
            });

            // Manejar confirmación de descarte
            btnConfirmar.addEventListener('click', function () {
                // El usuario confirmó descartar
                isDirty = false;
                intentionToClose = true;

                registroForm.reset();
                const alerts = document.getElementById('registroRapidoAlerts');
                if (alerts) alerts.innerHTML = '';

                modalConfirm.hide();
                // Esperar pequeño delay para que cierre el confirm y luego el principal
                setTimeout(() => {
                    const closeBtn = modalRegistro.querySelector('[data-bs-dismiss="modal"]');
                    if (closeBtn) closeBtn.click();
                    // O usar instancia bootstrap si el click no funciona bien por temas de foco
                    // bsModalRegistro.hide(); 
                }, 200);
            });

            // --- Lógica AJAX existente ---

            const modalBody = registroForm.parentElement;
            const modalAlertContainer = document.createElement('div');
            modalAlertContainer.id = 'registroRapidoAlerts';
            modalBody.insertBefore(modalAlertContainer, modalBody.firstChild);

            registroForm.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log("Interceptado submit de registroRapidoForm");

                // Logic que estaba en el onclick: copiar RUT a hidden
                const usernameInput = document.getElementsByName('username')[0];
                const rutHiddenInput = document.getElementById('rutHidden');
                if (usernameInput && rutHiddenInput) {
                    rutHiddenInput.value = usernameInput.value;
                }

                // Limpiar errores previos
                modalAlertContainer.innerHTML = '';

                const formData = new FormData(registroForm);

                const submitBtn = document.getElementById('btnRegistrarCliente');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Registrando...';
                }

                fetch(registroForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken') // Asegurar CSRF
                    }
                })
                    .then(response => {
                        return response.json().then(data => ({ status: response.status, body: data }));
                    })
                    .then(res => {
                        console.log("Respuesta servidor:", res);
                        if (res.body.success) {
                            // Éxito: Guardar mensaje flash y recargar
                            sessionStorage.setItem('flashMessage', 'Cliente registrado exitosamente');
                            sessionStorage.setItem('flashType', 'success');
                            location.reload();
                        } else {
                            // Error
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = 'Registrar Cliente';
                            }

                            let errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
                            errorHtml += '<strong>Error al registrar:</strong><ul class="mb-0">';

                            if (res.body.errors) {
                                if (typeof res.body.errors === 'string') {
                                    errorHtml += `<li>${res.body.errors}</li>`;
                                } else if (Array.isArray(res.body.errors)) {
                                    res.body.errors.forEach(err => errorHtml += `<li>${err}</li>`);
                                } else {
                                    for (const [field, msgs] of Object.entries(res.body.errors)) {
                                        // msgs puede ser array
                                        const msgText = Array.isArray(msgs) ? msgs.join(', ') : msgs;
                                        errorHtml += `<li><strong>${field}:</strong> ${msgText}</li>`;
                                    }
                                }
                            } else {
                                errorHtml += '<li>Ocurrió un error desconocido.</li>';
                            }

                            errorHtml += '</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            modalAlertContainer.innerHTML = errorHtml;

                            // Scroll al top del modal para ver errores
                            modalBody.scrollTop = 0;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetch:', error);
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Registrar Cliente';
                        }
                        modalAlertContainer.innerHTML = '<div class="alert alert-danger">Error de conexión o servidor. Intente más tarde.</div>';
                    });
            });
        }
        // --- Mostrar Mensaje Flash desde SessionStorage (al recargar) ---
        const flashMsg = sessionStorage.getItem('flashMessage');
        const flashType = sessionStorage.getItem('flashType');

        if (flashMsg) {
            let msgContainer = document.querySelector('.main-content .container');
            if (!msgContainer) {
                msgContainer = document.querySelector('body > .main-content');
                if (!msgContainer) msgContainer = document.body;
            }

            // Insertar alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${flashType || 'info'} alert-dismissible fade show mt-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
               <i class="fa-solid fa-check-circle me-2"></i> ${flashMsg}
               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            if (msgContainer.firstChild) {
                msgContainer.insertBefore(alertDiv, msgContainer.firstChild);
            } else {
                msgContainer.appendChild(alertDiv);
            }

            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 10000);

            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 10000);

            sessionStorage.removeItem('flashMessage');
            sessionStorage.removeItem('flashType');
        }

        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

    });
</script>
<!-- Modal Confirmar Cancelación Cita -->
<div class="modal fade" id="cancelarCitaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Cancelación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas cancelar esta cita? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <form id="formCancelarCita" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Sí, Cancelar Cita</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDeleteCita(citaId) {
        const form = document.getElementById('formCancelarCita');
        // Corregir URL hardcodeada con prefijo /api/
        form.action = `/api/dashboard/cancelar_cita/${citaId}/`;
        const modal = new bootstrap.Modal(document.getElementById('cancelarCitaModal'));
        modal.show();
    }

    // Validación de Urgencia y Fechas Pasadas
    document.addEventListener('DOMContentLoaded', function () {
        // Validación de Urgencia y Fechas Pasadas se manejan abajo o inline

        // Bloquear fechas pasadas en inputs datetime-local y date (registro mascota)
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const nowStr = now.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
            const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD

            // Datetime-local (Citas)
            const inputsFechaHora = document.querySelectorAll('input[type="datetime-local"]');
            inputsFechaHora.forEach(input => {
                input.min = nowStr;
            });

            // Date (Fecha registro mascota - dashboard)
            const inputFechaRegistro = document.querySelector('input[name="fecha_registro"]');
            if (inputFechaRegistro) {
                inputFechaRegistro.min = todayStr;
            }
        });
    });

    function checkUrgencia(input) {
        const fechaVal = new Date(input.value);
        if (isNaN(fechaVal.getTime())) return;

        // Contenedor de alerta (asumiendo estructura id="alertUrgencia...")
        // Para "Nueva Cita", el ID es alertUrgenciaNuevaCita
        // Para simplificar, buscamos el div .form-check hermano siguiente
        const alertDiv = input.parentElement.querySelector('.form-check');
        const checkInput = alertDiv ? alertDiv.querySelector('input[type="checkbox"]') : null;

        if (!alertDiv || !checkInput) return;

        let esEspecial = false;

        // 1. Domingo (0 en JS)
        if (fechaVal.getDay() === 0) {
            esEspecial = true;
        }

        // 2. Feriados Chile 2024-2025
        const fechaStr = fechaVal.toISOString().split('T')[0];
        const feriados = [
            '2024-01-01', '2024-03-29', '2024-03-30', '2024-05-01', '2024-05-21',
            '2024-06-09', '2024-06-20', '2024-07-16', '2024-08-15', '2024-09-18',
            '2024-09-19', '2024-09-20', '2024-10-12', '2024-10-27', '2024-10-31',
            '2024-11-01', '2024-12-08', '2024-12-25',
            '2025-01-01', '2025-04-18', '2025-04-19', '2025-05-01', '2025-05-21',
            '2025-06-20', '2025-06-29', '2025-07-16', '2025-08-15', '2025-09-18',
            '2025-09-19', '2025-10-12', '2025-10-31', '2025-11-01', '2025-12-08',
            '2025-12-25'
        ];

        if (feriados.includes(fechaStr)) {
            esEspecial = true;
        }

        if (esEspecial) {
            alertDiv.classList.remove('d-none');
            checkInput.required = true;
        } else {
            alertDiv.classList.add('d-none');
            checkInput.required = false;
            checkInput.checked = false;
        }
    }

    // Validación de Urgencia y Fechas Pasadas


    function checkUrgencia(input) {
        const fechaVal = new Date(input.value);
        if (isNaN(fechaVal.getTime())) return;

        // Contenedor de alerta (asumiendo estructura id="alertUrgencia...")
        // Para "Nueva Cita", el ID es alertUrgenciaNuevaCita
        // Para simplificar, buscamos el div .form-check hermano siguiente
        const alertDiv = input.parentElement.querySelector('.form-check');
        const checkInput = alertDiv ? alertDiv.querySelector('input[type="checkbox"]') : null;

        if (!alertDiv || !checkInput) return;

        let esEspecial = false;

        // 1. Domingo (0 en JS)
        if (fechaVal.getDay() === 0) {
            esEspecial = true;
        }

        // 2. Feriados Chile 2024-2025
        const fechaStr = fechaVal.toISOString().split('T')[0];
        const feriados = [
            '2024-01-01', '2024-03-29', '2024-03-30', '2024-05-01', '2024-05-21',
            '2024-06-09', '2024-06-20', '2024-07-16', '2024-08-15', '2024-09-18',
            '2024-09-19', '2024-09-20', '2024-10-12', '2024-10-27', '2024-10-31',
            '2024-11-01', '2024-12-08', '2024-12-25',
            '2025-01-01', '2025-04-18', '2025-04-19', '2025-05-01', '2025-05-21',
            '2025-06-20', '2025-06-29', '2025-07-16', '2025-08-15', '2025-09-18',
            '2025-09-19', '2025-10-12', '2025-10-31', '2025-11-01', '2025-12-08',
            '2025-12-25'
        ];

        if (feriados.includes(fechaStr)) {
            esEspecial = true;
        }

        if (esEspecial) {
            alertDiv.classList.remove('d-none');
            checkInput.required = true;
        } else {
            alertDiv.classList.add('d-none');
            checkInput.required = false;
            checkInput.checked = false;
        }
    }
</script>

<!-- Calendar JavaScript -->
<script src="{% static 'js/calendar.js' %}"></script>
<script>
    // Load appointment data
    {% if citas %}
    window.allAppointments = [
        {% for cita in citas %}
    {
        id: { { cita.id } },
        fecha_hora: '{{ cita.fecha_hora|date:"Y-m-d\TH:i" }}',
            mascota_nombre: '{{ cita.mascota.nombre|escapejs }}',
                tipo: '{{ cita.tipo|escapejs }}',
                    veterinario_nombre: '{{ cita.veterinario.nombre|escapejs }}',
                        estado: '{{ cita.estado|escapejs }}'
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
    ];
    {% else %}
    window.allAppointments = [];
    {% endif %}
</script>

<!-- Modal: Registrar Walk-in -->
<div class="modal fade" id="registrarWalkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Paciente Walk-in</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-walkin">
                    <div class="mb-3">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" id="walkin-cliente" required>
                            <option value="">Seleccione cliente...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mascota *</label>
                        <select class="form-select" id="walkin-mascota" required disabled>
                            <option value="">Primero seleccione un cliente</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Motivo de la visita *</label>
                        <textarea class="form-control" id="walkin-motivo" rows="3" required
                            placeholder="Ej: Vacuna antirrábica, Control general, Herida en pata..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Prioridad</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="prioridad" id="prioridad-normal"
                                    value="NORMAL" checked>
                                <label class="form-check-label" for="prioridad-normal">
                                    <i class="fa-solid fa-circle text-success"></i> Normal
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="prioridad" id="prioridad-urgente"
                                    value="URGENTE">
                                <label class="form-check-label" for="prioridad-urgente">
                                    <i class="fa-solid fa-circle text-danger"></i> Urgente
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="registrarWalkin()">
                    <i class="fa-solid fa-check me-2"></i>Registrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reagendar Cita Modal -->
<div class="modal fade" id="reagendarCitaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reagendar Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-reagendar" method="POST" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p><strong>Paciente:</strong> <span id="reagendar-mascota"></span></p>

                    <div class="mb-3">
                        <label for="reagendar-fecha" class="form-label">Nueva Fecha y Hora *</label>
                        <input type="datetime-local" class="form-control" id="reagendar-fecha" name="fecha_hora"
                            required>
                    </div>

                    <div class="mb-3">
                        <label for="reagendar-veterinario" class="form-label">Veterinario *</label>
                        <select class="form-select" id="reagendar-veterinario" name="veterinario" required>
                            {% for vet in veterinarios %}
                            <option value="{{ vet.id }}">Dr. {{ vet.nombre }} {{ vet.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="reagendar-urgencia" name="es_urgencia">
                            <label class="form-check-label" for="reagendar-urgencia">Es Urgencia (Permite
                                Domingos/Feriados)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="reagendar-motivo" class="form-label">Motivo de Reagendamiento *</label>
                        <textarea class="form-control" id="reagendar-motivo" name="motivo_reagendamiento" rows="2"
                            required placeholder="Indique la razón del cambio..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Mascotas -->
<div class="modal fade" id="verMascotasModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-paw"></i> Mascotas de <span
                        id="clienteNombreModal"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Notification area for success/error messages -->
                <div id="petModalNotification" class="alert alert-dismissible fade" role="alert" style="display:none;">
                    <span id="petModalNotificationText"></span>
                    <button type="button" class="btn-close"
                        onclick="document.getElementById('petModalNotification').style.display='none'"></button>
                </div>

                <div id="mascotasTableContainer" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Nombre</th>
                                <th>Especie</th>
                                <th>Raza</th>
                                <th>Género</th>
                                <th>Fecha Nac.</th>
                                <th style="min-width: 120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="mascotasTableBody">
                            <!-- Pets will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="noMascotasMessage" class="alert alert-info" style="display:none;">
                    <i class="fa-solid fa-info-circle"></i> Este cliente no tiene mascotas registradas.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Walk-in Queue JavaScript -->
<script>
    // CSRF Token global
    const csrftoken = '{{ csrf_token }}';

    // Abrir modal de reagendar (función global)
    window.openRescheduleModal = function (data) {
        // data: {id, start, veterinario_id, mascota}
        const modalEl = document.getElementById('reagendarCitaModal');
        if (!modalEl) {
            console.error('Modal de reagendar no encontrado');
            return;
        }

        document.getElementById('reagendar-mascota').textContent = data.mascota;
        document.getElementById('reagendar-fecha').value = data.start;
        document.getElementById('reagendar-veterinario').value = data.veterinario_id;
        document.getElementById('reagendar-motivo').value = ''; // Limpiar motivo anterior
        // Reset checkbox
        document.getElementById('reagendar-urgencia').checked = false;

        // Configurar action del form
        const form = document.getElementById('form-reagendar');
        form.action = `/api/dashboard/reagendar_cita/${data.id}/`;

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    };

    // Cargar mascotas cuando se selecciona un cliente
    document.getElementById('walkin-cliente')?.addEventListener('change', function () {
        const clienteId = this.value;
        const mascotaSelect = document.getElementById('walkin-mascota');

        if (!clienteId) {
            mascotaSelect.disabled = true;
            mascotaSelect.innerHTML = '<option value="">Primero seleccione un cliente</option>';
            return;
        }

        // Filtrar mascotas del cliente seleccionado
        console.log(`Cargando mascotas para cliente ID: ${clienteId}`);
        fetch(`/api/mascotas/?cliente=${clienteId}`)
            .then(r => {
                console.log('Response status:', r.status);
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('Data recibida:', data);
                // DRF devuelve {results: [...]} cuando hay paginación
                const mascotas = data.results || data;
                console.log('Mascotas:', mascotas);

                mascotaSelect.disabled = false;
                mascotaSelect.innerHTML = '<option value="">Seleccione mascota...</option>';

                if (mascotas.length === 0) {
                    mascotaSelect.innerHTML += '<option value="">Este cliente no tiene mascotas</option>';
                    return;
                }

                mascotas.forEach(m => {
                    mascotaSelect.innerHTML += `<option value="${m.id}">${m.nombre} (${m.especie})</option>`;
                });
            })
            .catch(err => {
                console.error('Error completo:', err);
                console.error('Error cargando mascotas:', err.message);
                mascotaSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
            });
    });

    // Registrar nuevo walk-in
    function registrarWalkin() {
        const form = document.getElementById('form-walkin');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const data = {
            cliente: document.getElementById('walkin-cliente').value,
            mascota: document.getElementById('walkin-mascota').value,
            motivo: document.getElementById('walkin-motivo').value,
            prioridad: document.querySelector('input[name="prioridad"]:checked').value,
            estado: 'ESPERANDO'
        };

        fetch('/api/lista-espera/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(result => {
                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('registrarWalkinModal')).hide();
                // Limpiar formulario
                form.reset();
                document.getElementById('walkin-mascota').disabled = true;
                // Recargar cola
                cargarColaWalkin();
                // Paciente registrado exitosamente (sin alert molesto)
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al registrar paciente');
            });
    }

    // Cargar cola del día
    function cargarColaWalkin() {
        fetch('/api/lista-espera/hoy/')
            .then(r => r.json())
            .then(cola => {
                const tbody = document.getElementById('walkin-tbody');

                if (cola.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fa-solid fa-inbox me-2"></i>No hay pacientes en espera
                        </td>
                    </tr>`;
                    return;
                }

                tbody.innerHTML = cola.map(p => {
                    const prioridadBadge = p.prioridad === 'URGENTE'
                        ? '<span class="badge bg-danger">Urgente</span>'
                        : '<span class="badge bg-success">Normal</span>';

                    const estadoBadge = p.estado === 'ESPERANDO'
                        ? '<span class="badge bg-warning text-dark">En Espera</span>'
                        : '<span class="badge bg-info">En Atención</span>';

                    const tiempoEspera = p.tiempo_espera
                        ? `${p.tiempo_espera} min`
                        : '-';

                    const acciones = p.estado === 'ESPERANDO'
                        ? `<button class="btn btn-sm btn-primary me-1" onclick="llamarSiguiente(${p.id})">
                           <i class="fa-solid fa-bell"></i> Llamar
                       </button>
                       <button class="btn btn-sm btn-danger" onclick="cancelarTurno(${p.id})">
                           <i class="fa-solid fa-times"></i>
                       </button>`
                        : `<button class="btn btn-sm btn-success" onclick="marcarAtendido(${p.id})">
                           <i class="fa-solid fa-check"></i> Atendido
                       </button>`;

                    return `
                    <tr>
                        <td><strong>#${String(p.numero_turno).padStart(3, '0')}</strong></td>
                        <td>${p.cliente_nombre || 'N/A'}</td>
                        <td>${p.mascota_nombre || 'N/A'}</td>
                        <td>${p.motivo || '-'}</td>
                        <td>${prioridadBadge}</td>
                        <td>${tiempoEspera}</td>
                        <td>${estadoBadge}</td>
                        <td>${acciones}</td>
                    </tr>`;
                }).join('');
            })
            .catch(err => {
                console.error('Error cargando cola:', err);
                document.getElementById('walkin-tbody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>Error cargando cola
                    </td>
                </tr>`;
            });
    }

    // Llamar siguiente paciente
    function llamarSiguiente(id) {


        fetch(`/api/lista-espera/${id}/llamar_siguiente/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al llamar paciente');
            });
    }

    // Marcar como atendido
    function marcarAtendido(id) {


        fetch(`/api/lista-espera/${id}/marcar_atendido/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al marcar como atendido');
            });
    }

    // Cancelar turno
    function cancelarTurno(id) {
        if (!confirm('¿Cancelar este turno?')) return;

        fetch(`/api/lista-espera/${id}/cancelar_turno/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
            .then(r => r.json())
            .then(() => {
                cargarColaWalkin();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al cancelar turno');
            });
    }

    // Helper para CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Cargar cola al cambiar al tab
    document.getElementById('espera-tab')?.addEventListener('shown.bs.tab', function () {
        cargarColaWalkin();
    });

    // Auto-refresh cada 30 segundos si el tab está activo
    setInterval(function () {
        const esperaTab = document.getElementById('espera');
        if (esperaTab && esperaTab.classList.contains('active')) {
            cargarColaWalkin();
        }
    }, 30000);

    // Filtro de Clientes en tiempo real
    function filtrarClientes() {
        const input = document.getElementById("buscador-clientes");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("tabla-clientes");
        const tr = table.getElementsByTagName("tr");

        // Recorrer todas las filas de la tabla (empezando en 1 para saltar el header)
        for (let i = 1; i < tr.length; i++) {
            // Columna 0: RUT, Columna 1: Nombre
            const tdRut = tr[i].getElementsByTagName("td")[0];
            const tdNombre = tr[i].getElementsByTagName("td")[1];

            if (tdRut || tdNombre) {
                const txtRut = tdRut.textContent || tdRut.innerText;
                const txtNombre = tdNombre.textContent || tdNombre.innerText;

                if (txtRut.toUpperCase().indexOf(filter) > -1 || txtNombre.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    // ===== PET MANAGEMENT MODAL FUNCTIONS =====

    // Open pets modal and load client's pets
    window.openPetsModal = function (clienteId, clienteNombre) {
        // Set client name in modal title
        document.getElementById('clienteNombreModal').textContent = clienteNombre;

        // Load pets data
        loadClientPets(clienteId);

        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('verMascotasModal'));
        modal.show();
    };

    // Load client pets via Django template (simplified version)
    function loadClientPets(clienteId) {
        const tableBody = document.getElementById('mascotasTableBody');
        const noMascotasMsg = document.getElementById('noMascotasMessage');
        const tableContainer = document.getElementById('mascotasTableContainer');

        // Clear existing content
        tableBody.innerHTML = '';

        // Fetch pets from server
        fetch(`/api/cliente/${clienteId}/mascotas/`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    tableContainer.style.display = 'none';
                    noMascotasMsg.style.display = 'block';
                } else {
                    tableContainer.style.display = 'block';
                    noMascotasMsg.style.display = 'none';

                    data.forEach(pet => {
                        const row = createPetRow(pet);
                        tableBody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading pets:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-danger">Error al cargar mascotas</td></tr>';
            });
    }

    // Create a pet table row
    function createPetRow(pet) {
        const tr = document.createElement('tr');
        tr.id = `pet-row-${pet.id}`;
        tr.innerHTML = `
            <td><span class="pet-nombre">${pet.nombre}</span><input type="text" class="form-control form-control-sm pet-nombre-edit" value="${pet.nombre}" style="display:none;"></td>
            <td><span class="pet-especie">${pet.especie}</span><input type="text" class="form-control form-control-sm pet-especie-edit" value="${pet.especie}" style="display:none;"></td>
            <td><span class="pet-raza">${pet.raza || '-'}</span><input type="text" class="form-control form-control-sm pet-raza-edit" value="${pet.raza || ''}" style="display:none;"></td>
            <td><span class="pet-genero">${pet.genero || '-'}</span><select class="form-select form-select-sm pet-genero-edit" style="display:none;"><option value="Macho" ${pet.genero === 'Macho' ? 'selected' : ''}>Macho</option><option value="Hembra" ${pet.genero === 'Hembra' ? 'selected' : ''}>Hembra</option></select></td>
            <td><span class="pet-fecha">${pet.fecha_nacimiento || '-'}</span><input type="date" class="form-control form-control-sm pet-fecha-edit" value="${pet.fecha_nacimiento || ''}" style="display:none;"></td>
            <td>
                <button class="btn btn-sm btn-outline-primary btn-edit-pet" onclick="editPet(${pet.id})"><i class="fa-solid fa-edit"></i></button>
                <button class="btn btn-sm btn-success btn-save-pet" onclick="savePet(${pet.id})" style="display:none;"><i class="fa-solid fa-save"></i></button>
                <button class="btn btn-sm btn-secondary btn-cancel-pet" onclick="cancelEdit(${pet.id})" style="display:none;"><i class="fa-solid fa-times"></i></button>
            </td>
        `;
        return tr;
    }

    // Edit pet - enable inline editing
    window.editPet = function (petId) {
        const row = document.getElementById(`pet-row-${petId}`);

        // Hide display spans, show input fields
        row.querySelectorAll('span[class^="pet-"]').forEach(span => span.style.display = 'none');
        row.querySelectorAll('input[class*="-edit"], select[class*="-edit"]').forEach(input => input.style.display = 'block');

        // Toggle buttons
        row.querySelector('.btn-edit-pet').style.display = 'none';
        row.querySelector('.btn-save-pet').style.display = 'inline-block';
        row.querySelector('.btn-cancel-pet').style.display = 'inline-block';
    };

    // Save pet changes
    window.savePet = function (petId) {
        const row = document.getElementById(`pet-row-${petId}`);

        const petData = {
            nombre: row.querySelector('.pet-nombre-edit').value,
            especie: row.querySelector('.pet-especie-edit').value,
            raza: row.querySelector('.pet-raza-edit').value,
            genero: row.querySelector('.pet-genero-edit').value,
            fecha_nacimiento: row.querySelector('.pet-fecha-edit').value
        };

        // Send update to server
        fetch(`/api/mascota/${petId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(petData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update display values
                    row.querySelector('.pet-nombre').textContent = petData.nombre;
                    row.querySelector('.pet-especie').textContent = petData.especie;
                    row.querySelector('.pet-raza').textContent = petData.raza || '-';
                    row.querySelector('.pet-genero').textContent = petData.genero || '-';
                    row.querySelector('.pet-fecha').textContent = petData.fecha_nacimiento || '-';

                    // Exit edit mode
                    cancelEdit(petId);

                    // Show success notification in modal
                    showPetNotification('Mascota actualizada correctamente', 'success');
                } else {
                    // Show error notification in modal
                    showPetNotification('Error al actualizar mascota: ' + (data.error || 'Error desconocido'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show error notification in modal
                showPetNotification('Error al guardar cambios', 'danger');
            });
    };

    // Cancel edit - restore display mode
    window.cancelEdit = function (petId) {
        const row = document.getElementById(`pet-row-${petId}`);

        // Show display spans, hide input fields
        row.querySelectorAll('span[class^="pet-"]').forEach(span => span.style.display = 'inline');
        row.querySelectorAll('input[class*="-edit"], select[class*="-edit"]').forEach(input => input.style.display = 'none');

        // Toggle buttons
        row.querySelector('.btn-edit-pet').style.display = 'inline-block';
        row.querySelector('.btn-save-pet').style.display = 'none';
        row.querySelector('.btn-cancel-pet').style.display = 'none';
    };

    // Show notification in pet modal
    function showPetNotification(message, type) {
        const notification = document.getElementById('petModalNotification');
        const notificationText = document.getElementById('petModalNotificationText');

        // Set message and type
        notificationText.textContent = message;
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.display = 'block';

        // Auto-hide after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.style.display = 'none';
            }, 150);
        }, 3000);
    }
</script>

{% endblock %}